# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a unified web application combining URL content extraction and Markdown viewing capabilities, built with Next.js and Azure Functions. The application provides:
1. **URL Content Extractor**: Extracts article content from URLs using Mozilla Readability
2. **Markdown Viewer**: Real-time Markdown editor with live preview, syntax highlighting, and debounced updates

Both applications are integrated into a single PWA with app selection interface and seamless navigation.

## Architecture

### Frontend (Next.js App)
- **App Router**: Uses Next.js 14 App Router with TypeScript
- **Static Export**: Configured for static export (`output: 'export'`) for Azure Static Web Apps deployment
- **PWA Support**: Includes service worker, manifest, and offline capabilities via next-pwa
- **Styling**: Tailwind CSS for UI components

### Backend (Azure Functions)
- **API Location**: `api/` directory with TypeScript Azure Functions
- **Content Extraction**: Uses @mozilla/readability and jsdom for web scraping
- **CORS Configuration**: Configured for cross-origin requests

### Key Components Structure
- `app/page.tsx`: App selection landing page with navigation to both applications
- `app/url-extractor/page.tsx`: URL content extraction application
- `app/markdown-viewer/page.tsx`: Markdown editor with live preview
- `app/components/app-selector.tsx`: Application selection interface
- `app/components/extract-form.tsx`: URL input and content display form
- `app/components/markdown/MarkdownPreview.tsx`: React Markdown renderer with syntax highlighting
- `app/hooks/useMarkdownParser.ts`: Debounced markdown parsing logic
- `app/hooks/useDebounce.ts`: Generic debounce utility hook
- `app/lib/markdown-constants.ts`: Markdown viewer constants and default content
- `api/src/functions/extractContent.ts`: URL content extraction API endpoint

## Development Commands

### Local Development
```bash
# Install dependencies for both frontend and API
npm install && cd api && npm install && cd ..

# Frontend development server only (includes both URL extractor and Markdown viewer)
npm run dev

# Build API separately
npm run build:api
# or: cd api && npm run build

# Run integrated environment (frontend + API together)
npm run swa:all

# Start with existing builds
npm run swa:start
```

### Markdown Viewer Dependencies
The following packages are integrated for Markdown functionality:
- `react-markdown`: Markdown rendering
- `highlight.js`: Syntax highlighting for code blocks
- `rehype-highlight`: Rehype plugin for syntax highlighting
- `remark-gfm`: GitHub Flavored Markdown support
- `@tailwindcss/typography`: Typography styles for prose content

### Production Builds
```bash
# Build frontend for static export
npm run build

# Build API
cd api && npm run build

# Both at once
npm run build && npm run build:api
```

### Testing and Linting
```bash
# Frontend linting
npm run lint

# API has no specific test/lint commands configured
```

## Key Technical Details

### Azure Functions API
- Single HTTP trigger function: `extractContent`
- Route: `POST /api/extractContent`
- Accepts: `{ url: string }`
- Returns: Article object with title, content, textContent, etc.
- Memory management: Explicitly closes JSDOM windows in finally blocks

### Static Export Configuration
- Output directory: `out/` (configured in next.config.mjs)
- Images: Unoptimized for static hosting
- PWA assets: Generated in `public/` directory

### PWA Features
- Offline HTML page: `public/offline.html`
- Service worker: Auto-generated by next-pwa
- Install prompt: Custom PWA install component
- Manifest: `public/manifest.json` with icon sets

### Custom Actions System
- Default actions defined in `app/config/default-actions.ts`
- User can create custom processing prompts
- Actions stored in localStorage
- Built-in actions: 要約 (Summary), 箇条書きでまとめ (Bullet points), 日本語に翻訳 (Translate to Japanese)

## Azure Static Web Apps Configuration

The project uses `staticwebapp.config.json` for deployment configuration:
- API runtime: Node.js 22.14.0
- Route handling for `/api/*` endpoints
- CSP headers for security
- Service worker caching configuration

## Important File Locations

- Frontend entry: `app/page.tsx`
- Main API: `api/src/functions/extractContent.ts`
- Build outputs: `out/` (frontend), `api/dist/` (API)
- Config files: `next.config.mjs`, `staticwebapp.config.json`, `tailwind.config.ts`
- PWA config: `public/manifest.json`, auto-generated service worker

## Development Guidelines

### Component Migration Strategy
When migrating external React components/apps to this Next.js project, **always use the "Selective Component Migration" approach**:

1. **Analyze Dependencies**: Identify core libraries needed (e.g., react-markdown, highlight.js)
2. **Install Dependencies**: Add only necessary packages to Next.js project
3. **Migrate Core Components**: Move essential components only, not entire applications
4. **Adapt to Next.js**: Update imports, styling, and configuration to match Next.js patterns
5. **Integration**: Create new routes and integrate with existing app structure

**Benefits**: Avoids dependency conflicts, maintains single build process, ensures UI/UX consistency, reduces bundle size, improves maintainability.

## Troubleshooting

### Common Development Issues

#### `npm run dev` Error: middleware-manifest.json
**Problem**: `Cannot find module 'out/server/middleware-manifest.json'`
**Cause**: Development mode conflicts with static export configuration
**Solution**: The `next.config.mjs` has been configured to only apply `output: 'export'` and `distDir: 'out'` in production builds:
```javascript
...(process.env.NODE_ENV === 'production' && {
  output: 'export',
  distDir: 'out',
})
```

#### Build Issues After Component Migration
1. **Check TypeScript exclusions**: Ensure `tsconfig.json` excludes conflicting directories
2. **Verify import paths**: All imports should use relative paths appropriate for Next.js structure
3. **CSS conflicts**: Use Tailwind classes consistently, avoid CSS modules conflicts

#### Playwright Testing
Before testing with Playwright:
1. Ensure dev server is running: `npm run dev`
2. Wait for compilation to complete
3. Test all navigation paths between apps
4. Verify PWA installation prompt appears

## Memory and Performance Notes

- JSDOM instances are explicitly cleaned up in API functions
- Service worker provides aggressive caching for static assets
- Content Security Policy configured for external API access
- Large content extraction may require increased Node.js memory limits
- Markdown rendering is debounced (300ms) to prevent excessive re-renders